name: Build YouTubeRebornPlus Dylib Only

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "iOS SDK version to be used during build"
        default: "17.5"
        required: true
        type: string

jobs:
  build:
    name: Build Tweak Dylib
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v5
        with:
          path: main
          submodules: recursive

      - name: Install Dependencies
        run: brew install ldid dpkg make

      - name: Setup Theos
        uses: actions/checkout@v5
        with:
          repository: theos/theos
          ref: master
          path: theos
          submodules: recursive

      - name: Download iOS SDK
        run: |
          # 建立目標資料夾
          mkdir -p ${{ github.workspace }}/theos/sdks
          # 直接下載單一 SDK 到指定路徑 (不使用 git clone 以免路徑混亂)
          curl -L https://github.com/theos/sdks/raw/master/iPhoneOS${{ inputs.sdk_version }}.sdk.tar.xz -o sdk.tar.xz
          tar -xf sdk.tar.xz -C ${{ github.workspace }}/theos/sdks/
          # 確認 SDK 是否真的在那裡 (Debug 用)
          ls -R ${{ github.workspace }}/theos/sdks/

      - name: Build Tweak (Dylib & Deb)
        id: build_tweak
        run: |
          cd ${{ github.workspace }}/main
          export THEOS=${{ github.workspace }}/theos
          
          # 修正 Makefile：將 jailed 轉為 tweak 模式
          sed -i '' 's/jailed.mk/tweak.mk/g' Makefile
          
          # 編譯指令，並明確指定 SDK 路徑
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless \
            SDKROOT=${{ github.workspace }}/theos/sdks/iPhoneOS${{ inputs.sdk_version }}.sdk
          
          # 取得產出的 deb 檔名
          DEB_NAME=$(ls packages/*.deb | head -n 1)
          echo "deb_path=$DEB_NAME" >> $GITHUB_OUTPUT
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Extract Dylib from Deb
        run: |
          cd ${{ github.workspace }}/main
          # 解壓 deb 提取 dylib
          ar -x packages/*.deb
          tar -xf data.tar.*
          # 搜尋 dylib 並移動到方便上傳的位置
          mkdir -p out_assets
          find Library/MobileSubstrate/DynamicLibraries/ -name "*.dylib" -exec cp {} out_assets/ \;
          find Library/MobileSubstrate/DynamicLibraries/ -name "*.plist" -exec cp {} out_assets/ \;

      - name: Upload Dylib Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YouTubeRebornPlus-Dylib
          path: main/out_assets/*
