name: Build YouTubeRebornPlus Dylib

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "iOS SDK version"
        default: "16.5"
        required: true
        type: string

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: brew install ldid dpkg make

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV

      - name: Download iOS SDK
        run: |
          mkdir -p ~/theos/sdks
          # 直接下載特定的 SDK 壓縮檔，並解除嵌套資料夾
          curl -L "https://github.com/theos/sdks/archive/master.tar.gz" -o sdks.tar.gz
          tar -xzf sdks.tar.gz --strip-components=1 -C ~/theos/sdks
          
          # 自動修正：將所有資料夾移動到 ~/theos/sdks 根目錄下（防止路徑躲在 sdks-master 裡）
          # 同時列出內容以供 Debug
          echo "Checking SDKs location:"
          ls -d ~/theos/sdks/*/ || echo "No subdirectories found"
          ls ~/theos/sdks/

      - name: Patch Makefile for Dylib Build
        run: |
          cd ${{ github.workspace }}
          # 1. 將 jailed.mk 替換為 tweak.mk
          sed -i '' 's/jailed.mk/tweak.mk/g' Makefile
          
          # 2. 強制刪除 Makefile 中可能存在的 TARGET 或 SDK 版本宣告
          # 這樣 Theos 就會完全聽從我們在命令列傳入的 SDKROOT
          sed -i '' '/^TARGET =/d' Makefile
          sed -i '' '/^SYSROOT =/d' Makefile
          
          # 3. 註釋掉強制要求 IPA 的行
          sed -i '' 's/^[^#]*IPA *=/#&/' Makefile
          
          # 4. 確保輸出為 rootless
          echo "THEOS_PACKAGE_SCHEME = rootless" >> Makefile

      - name: Compile Tweak
        run: |
          export THEOS=~/theos
          # 自動尋找系統中存在的 SDK 路徑，避免手動輸入錯誤
          SDK_PATH=$(find ~/theos/sdks -name "iPhoneOS${{ inputs.sdk_version }}.sdk" -type d | head -n 1)
          
          if [ -z "$SDK_PATH" ]; then
            echo "Error: SDK iPhoneOS${{ inputs.sdk_version }}.sdk not found!"
            ls -R ~/theos/sdks
            exit 1
          fi
          
          echo "Using SDK at: $SDK_PATH"
          make package FINALPACKAGE=1 SDKROOT="$SDK_PATH" THEOS_PACKAGE_SCHEME=rootless

      - name: Extract Dylib and Plist
        run: |
          # 建立輸出目錄
          mkdir -p ./output_assets
          
          # 找到編譯出的 .deb 文件並解壓
          DEB_FILE=$(find packages -name "*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then echo "No deb found!"; exit 1; fi
          
          dpkg-deb -x "$DEB_FILE" ./temp_deb
          
          # 提取 dylib 和 plist
          find ./temp_deb -name "*.dylib" -exec cp {} ./output_assets/ \;
          find ./temp_deb -name "*.plist" -exec cp {} ./output_assets/ \;
          
          echo "Extracted files:"
          ls ./output_assets/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YouTubeRebornPlus-Dylib-Files
          path: ./output_assets/*
