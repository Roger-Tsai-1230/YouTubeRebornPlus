name: Build YouTubeRebornPlus Dylib Only

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "iOS SDK version to be used during build"
        default: "17.5"
        required: true
        type: string

jobs:
  build:
    name: Build Tweak Dylib
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v5
        with:
          path: main
          submodules: recursive

      - name: Install Dependencies
        run: brew install ldid dpkg make

      - name: Setup Theos
        uses: actions/checkout@v5
        with:
          repository: theos/theos
          ref: master
          path: theos
          submodules: recursive

      - name: Download iOS SDK
        run: |
          git clone --quiet --depth=1 https://github.com/theos/sdks.git
          mkdir -p ${{ github.workspace }}/theos/sdks
          # 直接移動特定的 SDK 資料夾，避免使用萬用字元造成匹配失敗
          mv sdks/iPhoneOS${{ inputs.sdk_version }}.sdk ${{ github.workspace }}/theos/sdks/
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Build Tweak (Dylib & Deb)
        id: build_tweak
        run: |
          cd ${{ github.workspace }}/main
          export THEOS=${{ github.workspace }}/theos
          # 修改 Makefile 移除 jailed 依賴，改為標準編譯
          sed -i '' 's/include $(THEOS)\/makefiles\/common.mk/include $(THEOS)\/makefiles\/common.mk/g' Makefile
          
          # 核心編譯指令：只編譯插件不打包 iPA
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless
          
          # 尋找產出的 .deb 文件
          DEB_NAME=$(ls packages/*.deb | head -n 1)
          echo "deb_path=$DEB_NAME" >> $GITHUB_OUTPUT
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Extract Dylib from Deb
        run: |
          cd ${{ github.workspace }}/main
          # 解壓 deb 提取 dylib
          ar -x packages/*.deb
          tar -xf data.tar.*
          # 搜尋 dylib 並移動到方便上傳的位置
          mkdir -p out_assets
          find Library/MobileSubstrate/DynamicLibraries/ -name "*.dylib" -exec cp {} out_assets/ \;
          find Library/MobileSubstrate/DynamicLibraries/ -name "*.plist" -exec cp {} out_assets/ \;

      - name: Upload Dylib Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YouTubeRebornPlus-Dylib
          path: main/out_assets/*
