name: Build YouTubeRebornPlus Dylib

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "iOS SDK version"
        default: "16.5"
        required: true
        type: string

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: brew install ldid dpkg make

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV

      - name: Download iOS SDK
        run: |
          mkdir -p ~/theos/sdks
          # 使用更穩定的 SDK 來源並直接解壓
          curl -L "https://github.com/theos/sdks/archive/master.tar.gz" | tar -xz --strip-components=1 -C ~/theos/sdks
          # 檢查 SDK 是否存在
          ls ~/theos/sdks/iPhoneOS${{ inputs.sdk_version }}.sdk || echo "SDK not found, check version input"

      - name: Patch Makefile for Dylib Build
        run: |
          # 1. 將 jailed.mk 替換為 tweak.mk (核心修改)
          sed -i '' 's/jailed.mk/tweak.mk/g' Makefile
          
          # 2. 註釋掉任何強制要求 IPA 或封裝 IPA 的行
          sed -i '' 's/^[^#]*IPA *=/#&/' Makefile
          sed -i '' 's/^[^#]*INSTALL_TARGET_PROCESSES *=/#&/' Makefile
          
          # 3. 確保輸出為 rootless 格式以利於現代設備使用
          echo "THEOS_PACKAGE_SCHEME = rootless" >> Makefile

      - name: Compile Tweak
        run: |
          export THEOS=~/theos
          # 使用指定 SDK 進行編譯
          make package FINALPACKAGE=1 SDKROOT=~/theos/sdks/iPhoneOS${{ inputs.sdk_version }}.sdk

      - name: Extract Dylib and Plist
        run: |
          # 建立輸出目錄
          mkdir -p ./output_assets
          
          # 找到編譯出的 .deb 文件並解壓
          DEB_FILE=$(find packages -name "*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then echo "No deb found!"; exit 1; fi
          
          dpkg-deb -x "$DEB_FILE" ./temp_deb
          
          # 提取 dylib 和 plist
          find ./temp_deb -name "*.dylib" -exec cp {} ./output_assets/ \;
          find ./temp_deb -name "*.plist" -exec cp {} ./output_assets/ \;
          
          echo "Extracted files:"
          ls ./output_assets/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YouTubeRebornPlus-Dylib-Files
          path: ./output_assets/*
