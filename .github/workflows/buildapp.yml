name: Build YouTubeRebornPlus Dylib

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: "iOS SDK version"
        default: "16.5"
        required: true
        type: string

jobs:
  build:
    name: Build Tweak
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: brew install ldid dpkg make

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          echo "THEOS=~/theos" >> $GITHUB_ENV

      - name: Download iOS SDK
        run: |
          mkdir -p ~/theos/sdks
          # 直接下載特定的 SDK 壓縮檔，並解除嵌套資料夾
          curl -L "https://github.com/theos/sdks/archive/master.tar.gz" -o sdks.tar.gz
          tar -xzf sdks.tar.gz --strip-components=1 -C ~/theos/sdks
          
          # 自動修正：將所有資料夾移動到 ~/theos/sdks 根目錄下（防止路徑躲在 sdks-master 裡）
          # 同時列出內容以供 Debug
          echo "Checking SDKs location:"
          ls -d ~/theos/sdks/*/ || echo "No subdirectories found"
          ls ~/theos/sdks/

      - name: Patch Makefile for Dylib Build
        run: |
          # 1. 刪除所有硬編碼的環境設定
          sed -i '' '/^export TARGET =/d' Makefile
          sed -i '' '/^export SDK_PATH =/d' Makefile
          sed -i '' '/^export SYSROOT =/d' Makefile
          
          # 2. 修正編譯模式
          sed -i '' 's/jailed.mk/tweak.mk/g' Makefile
          
          # 3. 清理子專案的 Makefile
          find Tweaks -name "Makefile" -exec sed -i '' '/^export TARGET =/d' {} +
          find Tweaks -name "Makefile" -exec sed -i '' '/^export SDK_PATH =/d' {} +
          find Tweaks -name "Makefile" -exec sed -i '' '/^export SYSROOT =/d' {} +

          # 4. 【核心修正】強制關閉 -Werror，允許棄用警告通過
          # 在全局 Makefile 加入忽略警告的參數
          echo "ADDITIONAL_CFLAGS += -Wno-error -Wno-deprecated-declarations" >> Makefile
          
          # 5. 確保輸出為 rootless
          echo "THEOS_PACKAGE_SCHEME = rootless" >> Makefile

      - name: Compile Tweak
        run: |
          export THEOS=~/theos
          SDK_PATH=$(find ~/theos/sdks -name "iPhoneOS${{ inputs.sdk_version }}.sdk" -type d | head -n 1)
          
          # 同時傳入多個覆蓋參數，確保子專案也同步
          make package FINALPACKAGE=1 \
            SDKROOT="$SDK_PATH" \
            SYSROOT="$SDK_PATH" \
            TARGET=iphone:clang:${{ inputs.sdk_version }}:14.0 \
            THEOS_PACKAGE_SCHEME=rootless \
            FOR_RELEASE=1

      - name: Extract Dylib and Plist
        run: |
          # 建立輸出目錄
          mkdir -p ./output_assets
          
          # 找到編譯出的 .deb 文件並解壓
          DEB_FILE=$(find packages -name "*.deb" | head -n 1)
          if [ -z "$DEB_FILE" ]; then echo "No deb found!"; exit 1; fi
          
          dpkg-deb -x "$DEB_FILE" ./temp_deb
          
          # 提取 dylib 和 plist
          find ./temp_deb -name "*.dylib" -exec cp {} ./output_assets/ \;
          find ./temp_deb -name "*.plist" -exec cp {} ./output_assets/ \;
          
          echo "Extracted files:"
          ls ./output_assets/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: YouTubeRebornPlus-Dylib-Files
          path: ./output_assets/*
